!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("netlify-cms-lib-util"),require("react"),require("netlify-cms-ui-default"),require("react-emotion"),require("netlify-cms-backend-github"),require("netlify-cms-backend-gitlab"),require("prop-types"),require("netlify-cms-backend-bitbucket"),require("lodash/partial"),require("lodash/intersection"),require("lodash/pick"),require("lodash/get"),require("lodash/flow")):"function"==typeof define&&define.amd?define("netlify-cms-backend-git-gateway",["netlify-cms-lib-util","react","netlify-cms-ui-default","react-emotion","netlify-cms-backend-github","netlify-cms-backend-gitlab","prop-types","netlify-cms-backend-bitbucket","lodash/partial","lodash/intersection","lodash/pick","lodash/get","lodash/flow"],t):"object"==typeof exports?exports["netlify-cms-backend-git-gateway"]=t(require("netlify-cms-lib-util"),require("react"),require("netlify-cms-ui-default"),require("react-emotion"),require("netlify-cms-backend-github"),require("netlify-cms-backend-gitlab"),require("prop-types"),require("netlify-cms-backend-bitbucket"),require("lodash/partial"),require("lodash/intersection"),require("lodash/pick"),require("lodash/get"),require("lodash/flow")):e["netlify-cms-backend-git-gateway"]=t(e["netlify-cms-lib-util"],e.react,e["netlify-cms-ui-default"],e["react-emotion"],e["netlify-cms-backend-github"],e["netlify-cms-backend-gitlab"],e["prop-types"],e["netlify-cms-backend-bitbucket"],e["lodash/partial"],e["lodash/intersection"],e["lodash/pick"],e["lodash/get"],e["lodash/flow"])}(window,function(e,t,r,n,i,o,s,a,u,c,l,h,d){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=21)}([function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t){e.exports=r},function(e,t){e.exports=n},function(e,t){e.exports=i},function(e,t){e.exports=o},function(e,t){e.exports=s},function(e,t){e.exports=a},function(e,t){e.exports=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JSONHTTPError=t.TextHTTPError=t.HTTPError=void 0;var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(16);function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function c(e){function t(){var t=Reflect.construct(e,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return t.prototype=Object.create(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e,t}var l=t.HTTPError=function(e){function t(e){s(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e.statusText));return r.name=r.constructor.name,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(r,r.constructor):r.stack=new Error(e.statusText).stack,r.status=e.status,r}return u(t,c(Error)),t}(),h=t.TextHTTPError=function(e){function t(e,r){s(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.data=r,n}return u(t,l),t}(),d=t.JSONHTTPError=function(e){function t(e,r){s(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.json=r,n}return u(t,l),t}(),f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=arguments[1];s(this,e),this.apiURL=t,this.apiURL.match(/\/[^\/]?/)&&(this._sameOrigin=!0),this.defaultHeaders=r&&r.defaultHeaders||{}}return i(e,[{key:"headers",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return n({},this.defaultHeaders,{"Content-Type":"application/json"},e)}},{key:"parseJsonResponse",value:function(e){return e.json().then(function(t){if(!e.ok)return Promise.reject(new d(e,t));var r=(0,o.getPagination)(e);return r?{pagination:r,items:t}:t})}},{key:"request",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this.headers(r.headers||{});return this._sameOrigin&&(r.credentials=r.credentials||"same-origin"),fetch(this.apiURL+e,n({},r,{headers:i})).then(function(e){var r=e.headers.get("Content-Type");return r&&r.match(/json/)?t.parseJsonResponse(e):e.ok?e.text().then(function(e){}):e.text().then(function(t){return Promise.reject(new h(e,t))})})}}]),e}();t.default=f},function(e,t){e.exports=c},function(e,t){e.exports=l},function(e,t){e.exports=h},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=r(9),o=a(i),s=a(r(17));function a(e){return e&&e.__esModule?e:{default:e}}var u=/^http:\/\//,c="/.netlify/identity",l=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.APIUrl,n=void 0===r?c:r,i=t.audience,s=void 0===i?"":i,a=t.setCookie,l=void 0!==a&&a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n.match(u)&&console.warn("Warning:\n\nDO NOT USE HTTP IN PRODUCTION FOR GOTRUE EVER!\nGoTrue REQUIRES HTTPS to work securely."),s&&(this.audience=s),this.setCookie=l,this.api=new o.default(n)}return n(e,[{key:"_request",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.headers=t.headers||{};var r=t.audience||this.audience;return r&&(t.headers["X-JWT-AUD"]=r),this.api.request(e,t).catch(function(e){return e instanceof i.JSONHTTPError&&e.json&&(e.json.msg?e.message=e.json.msg:e.json.error&&(e.message=e.json.error+": "+e.json.error_description)),Promise.reject(e)})}},{key:"settings",value:function(){return this._request("/settings")}},{key:"signup",value:function(e,t,r){return this._request("/signup",{method:"POST",body:JSON.stringify({email:e,password:t,data:r})})}},{key:"login",value:function(e,t,r){var n=this;return this._setRememberHeaders(r),this._request("/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"grant_type=password&username="+encodeURIComponent(e)+"&password="+encodeURIComponent(t)}).then(function(e){return s.default.removeSavedSession(),n.createUser(e,r)})}},{key:"loginExternalUrl",value:function(e){return this.api.apiURL+"/authorize?provider="+e}},{key:"confirm",value:function(e,t){return this._setRememberHeaders(t),this.verify("signup",e,t)}},{key:"requestPasswordRecovery",value:function(e){return this._request("/recover",{method:"POST",body:JSON.stringify({email:e})})}},{key:"recover",value:function(e,t){return this._setRememberHeaders(t),this.verify("recovery",e,t)}},{key:"acceptInvite",value:function(e,t,r){var n=this;return this._setRememberHeaders(r),this._request("/verify",{method:"POST",body:JSON.stringify({token:e,password:t,type:"signup"})}).then(function(e){return n.createUser(e,r)})}},{key:"acceptInviteExternalUrl",value:function(e,t){return this.api.apiURL+"/authorize?provider="+e+"&invite_token="+t}},{key:"createUser",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._setRememberHeaders(t),new s.default(this.api,e,this.audience).getUserData().then(function(e){return t&&e._saveSession(),e})}},{key:"currentUser",value:function(){var e=s.default.recoverSession(this.api);return e&&this._setRememberHeaders(e._fromStorage),e}},{key:"verify",value:function(e,t,r){var n=this;return this._setRememberHeaders(r),this._request("/verify",{method:"POST",body:JSON.stringify({token:t,type:e})}).then(function(e){return n.createUser(e,r)})}},{key:"_setRememberHeaders",value:function(e){this.setCookie&&(this.api.defaultHeaders=this.api.defaultHeaders||{},this.api.defaultHeaders["X-Use-Cookie"]=e?"1":"session")}}]),e}();t.default=l,"undefined"!=typeof window&&(window.GoTrue=l)},function(e,t,r){"use strict";var n=r(19);function i(e){this.message=e}i.prototype=new Error,i.prototype.name="InvalidTokenError",e.exports=function(e,t){if("string"!=typeof e)throw new i("Invalid token specified");var r=!0===(t=t||{}).header?0:1;try{return JSON.parse(n(e.split(".")[r]))}catch(e){throw new i("Invalid token specified: "+e.message)}},e.exports.InvalidTokenError=i},function(e,t){e.exports=d},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw o}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.getPagination=function(e){var t=e.headers.get("Link"),r={};if(null==t)return null;t=t.split(",");for(var i=e.headers.get("X-Total-Count"),o=0,s=t.length;o<s;o++){var a=t[o].replace(/(^\s*|\s*$)/,""),u=a.split(";"),c=n(u,2),l=c[0],h=c[1],d=l.match(/page=(\d+)/),f=d&&parseInt(d[1],10);h.match(/last/)?r.last=f:h.match(/next/)?r.next=f:h.match(/prev/)?r.prev=f:h.match(/first/)&&(r.first=f)}return r.last=Math.max(r.last||0,r.prev&&r.prev+1||0),r.current=r.next?r.next-1:r.last||1,r.total=i?parseInt(i,10):null,r}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(9),s=u(o),a=u(r(18));function u(e){return e&&e.__esModule?e:{default:e}}var c={},l=null,h={api:1,token:1,audience:1,url:1},d={api:1},f=function(){function e(t,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.api=t,this.url=t.apiURL,this.audience=n,this._processTokenResponse(r),l=this}return i(e,[{key:"update",value:function(e){var t=this;return this._request("/user",{method:"PUT",body:JSON.stringify(e)}).then(function(e){return t._saveUserData(e)._refreshSavedSession()})}},{key:"jwt",value:function(e){var t=this.tokenDetails(),r=t.expires_at,n=t.refresh_token,i=t.access_token;return e||r-6e4<Date.now()?this._refreshToken(n):Promise.resolve(i)}},{key:"logout",value:function(){return this._request("/logout",{method:"POST"}).then(this.clearSession.bind(this)).catch(this.clearSession.bind(this))}},{key:"_refreshToken",value:function(e){var t=this;return c[e]?c[e]:c[e]=this.api.request("/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"grant_type=refresh_token&refresh_token="+e}).then(function(r){return delete c[e],t._processTokenResponse(r),t._refreshSavedSession(),t.token.access_token}).catch(function(r){return delete c[e],t.clearSession(),Promise.reject(r)})}},{key:"_request",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r.headers=r.headers||{};var i=r.audience||this.audience;return i&&(r.headers["X-JWT-AUD"]=i),this.jwt().then(function(i){return t.api.request(e,n({headers:Object.assign(r.headers,{Authorization:"Bearer "+i})},r)).catch(function(e){return e instanceof o.JSONHTTPError&&e.json&&(e.json.msg?e.message=e.json.msg:e.json.error&&(e.message=e.json.error+": "+e.json.error_description)),Promise.reject(e)})})}},{key:"getUserData",value:function(){return this._request("/user").then(this._saveUserData.bind(this)).then(this._refreshSavedSession.bind(this))}},{key:"_saveUserData",value:function(t,r){for(var n in t)n in e.prototype||n in h||(this[n]=t[n]);return r&&(this._fromStorage=!0),this}},{key:"_processTokenResponse",value:function(e){this.token=e;var t=void 0;try{t=JSON.parse(function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}var r=window.atob(t);try{return decodeURIComponent(escape(r))}catch(e){return r}}(e.access_token.split(".")[1])),this.token.expires_at=1e3*t.exp}catch(t){console.error(new Error("Gotrue-js: Failed to parse tokenResponse claims: "+JSON.stringify(e)))}}},{key:"_refreshSavedSession",value:function(){return localStorage.getItem("gotrue.user")&&this._saveSession(),this}},{key:"_saveSession",value:function(){return localStorage.setItem("gotrue.user",JSON.stringify(this._details)),this}},{key:"tokenDetails",value:function(){return this.token}},{key:"clearSession",value:function(){e.removeSavedSession(),this.token=null,l=null}},{key:"admin",get:function(){return new a.default(this)}},{key:"_details",get:function(){var t={};for(var r in this)r in e.prototype||r in d||(t[r]=this[r]);return t}}],[{key:"removeSavedSession",value:function(){localStorage.removeItem("gotrue.user")}},{key:"recoverSession",value:function(t){if(l)return l;var r=localStorage.getItem("gotrue.user");if(r)try{var n=JSON.parse(r),i=n.url,o=n.token,a=n.audience;return i&&o?new e(t||new s.default(i,{}),o,a)._saveUserData(n,!0):null}catch(e){return console.error(new Error("Gotrue-js: Error recovering session: "+e)),null}return null}}]),e}();t.default=f},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();var i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.user=t}return n(e,[{key:"listUsers",value:function(e){return this.user._request("/admin/users",{method:"GET",audience:e})}},{key:"getUser",value:function(e){return this.user._request("/admin/users/"+e.id)}},{key:"updateUser",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.user._request("/admin/users/"+e.id,{method:"PUT",body:JSON.stringify(t)})}},{key:"createUser",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.email=e,r.password=t,this.user._request("/admin/users",{method:"POST",body:JSON.stringify(r)})}},{key:"deleteUser",value:function(e){return this.user._request("/admin/users/"+e.id,{method:"DELETE"})}}]),e}();t.default=i},function(e,t,r){var n=r(20);e.exports=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(n(e).replace(/(.)/g,function(e,t){var r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}(t)}catch(e){return n(t)}}},function(e,t){var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function n(e){this.message=e}n.prototype=new Error,n.prototype.name="InvalidCharacterError",e.exports="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new n("'atob' failed: The string to be decoded is not correctly encoded.");for(var i,o,s=0,a=0,u="";o=t.charAt(a++);~o&&(i=s%4?64*i+o:o,s++%4)?u+=String.fromCharCode(255&i>>(-2*s&6)):0)o=r.indexOf(o);return u}},function(e,t,r){"use strict";r.r(t);var n=r(10),i=r.n(n),o=r(11),s=r.n(o),a=r(12),u=r.n(a),c=r(13),l=r.n(c),h=r(14),d=r.n(h),f=r(0),p=r(4),y=r(5),m=r(7);function b(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){g(e,t,r[t])})}return e}function g(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class v extends p.API{constructor(e){super(e),this.api_root=e.api_root,this.tokenPromise=e.tokenPromise,this.commitAuthor=e.commitAuthor,this.repoURL=""}hasWriteAccess(){return this.getBranch().then(()=>!0).catch(e=>{if(401===e.status){if("Bad credentials"===e.message)throw new f.APIError("Git Gateway Error: Please ask your site administrator to reissue the Git Gateway token.",e.status,"Git Gateway");return!1}throw 404!==e.status||void 0!==e.message&&"Unable to locate site configuration"!==e.message?(console.error("Problem fetching repo data from Git Gateway"),e):new f.APIError("Git Gateway Error: Please make sure Git Gateway is enabled on your site.",e.status,"Git Gateway")})}getRequestHeaders(e={}){return this.tokenPromise().then(t=>{return b({Authorization:`Bearer ${t}`,"Content-Type":"application/json"},e)})}urlFor(e,t){const r=[`ts=${(new Date).getTime()}`];if(t.params)for(const e in t.params)r.push(`${e}=${encodeURIComponent(t.params[e])}`);return r.length&&(e+=`?${r.join("&")}`),this.api_root+e}user(){return Promise.resolve(this.commitAuthor)}request(e,t={}){const r=this.urlFor(e,t);let n;return this.getRequestHeaders(t.headers||{}).then(e=>fetch(r,b({},t,{headers:e}))).then(e=>{n=e.status;const t=e.headers.get("Content-Type");if(t&&t.match(/json/))return this.parseJsonResponse(e);const r=e.text();return e.ok?r:Promise.reject(r)}).catch(e=>{throw new f.APIError(e.message||e.msg,n,"Git Gateway")})}commit(e,t){const r={message:e,tree:t.sha,parents:t.parentSha?[t.parentSha]:[]};return this.commitAuthor&&(r.author=b({},this.commitAuthor,{date:(new Date).toISOString()})),this.request("/git/commits",{method:"POST",body:JSON.stringify(r)})}}var w=r(15),k=r.n(w);function _(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class P extends y.API{constructor(e){super(e),_(this,"authenticateRequest",async e=>f.unsentRequest.withHeaders({Authorization:`Bearer ${await this.tokenPromise()}`},e)),_(this,"request",async e=>k()([this.buildRequest,this.authenticateRequest,Object(f.then)(f.unsentRequest.performRequest)])(e)),_(this,"hasWriteAccess",()=>Promise.resolve(!0)),this.tokenPromise=e.tokenPromise,this.commitAuthor=e.commitAuthor,this.repoURL=""}}var O=r(8),S=r.n(O),j=r(6),T=r.n(j),E=r(1),q=r.n(E),I=r(3),x=r.n(I),U=r(2);function R(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const C=x()("button",{target:"ey01qwa0"})(U.buttons.button,";",U.shadows.dropDeep,";",U.buttons.default,";",U.buttons.gray,";padding:0 30px;display:block;margin-top:20px;margin-left:auto;"),A=x()("form",{target:"ey01qwa1"})("width:350px;margin-top:-80px;"),G=x()("input",{target:"ey01qwa2"})("background-color:",U.colorsRaw.white,";border-radius:",U.lengths.borderRadius,";font-size:14px;padding:10px 10px;margin-bottom:15px;margin-top:6px;width:100%;position:relative;z-index:1;&:focus{outline:none;box-shadow:inset 0 0 0 2px ",U.colors.active,";}"),H=x()("p",{target:"ey01qwa3"})("color:",U.colors.errorText,";");let L=null;window.netlifyIdentity&&(window.netlifyIdentity.on("login",e=>{L&&L.handleIdentityLogin(e)}),window.netlifyIdentity.on("logout",()=>{L&&L.handleIdentityLogout()}));class N extends q.a.Component{constructor(e){super(e),R(this,"handleIdentityLogin",e=>{this.props.onLogin(e),window.netlifyIdentity.close()}),R(this,"handleIdentityLogout",()=>{window.netlifyIdentity.open()}),R(this,"handleIdentity",()=>{const e=window.netlifyIdentity.currentUser();e?this.props.onLogin(e):window.netlifyIdentity.open()}),R(this,"state",{email:"",password:"",errors:{}}),R(this,"handleChange",(e,t)=>{this.setState(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){R(e,t,r[t])})}return e}({},this.state,{[e]:t.target.value}))}),R(this,"handleLogin",e=>{e.preventDefault();const t=this.state,r=t.email,n=t.password,i={};r||(i.email="Make sure to enter your email."),n||(i.password="Please enter your password."),Object.keys(i).length>0?this.setState({errors:i}):U.AuthenticationPage.authClient.login(this.state.email,this.state.password,!0).then(e=>{this.props.onLogin(e)}).catch(e=>{this.setState({errors:{server:e.description||e.msg||e},loggingIn:!1})})}),L=this}componentDidMount(){!this.loggedIn&&window.netlifyIdentity&&window.netlifyIdentity.currentUser()&&(this.props.onLogin(window.netlifyIdentity.currentUser()),window.netlifyIdentity.close())}componentWillUnmount(){L=null}render(){const e=this.state.errors,t=this.props,r=t.error,n=t.inProgress;return window.netlifyIdentity?q.a.createElement(U.AuthenticationPage,{onLogin:this.handleIdentity,renderButtonContent:()=>"Login with Netlify Identity"}):q.a.createElement(U.AuthenticationPage,{renderPageContent:()=>q.a.createElement(A,{onSubmit:this.handleLogin},r?q.a.createElement(H,null,r):null,e.server?q.a.createElement(H,null,e.server):null,q.a.createElement(H,null,e.email||null),q.a.createElement(G,{type:"text",name:"email",placeholder:"Email",value:this.state.email,onChange:S()(this.handleChange,"email")}),q.a.createElement(H,null,e.password||null),q.a.createElement(G,{type:"password",name:"password",placeholder:"Password",value:this.state.password,onChange:S()(this.handleChange,"password")}),q.a.createElement(C,{disabled:n},n?"Logging in...":"Login"))})}}function D(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){J(e,t,r[t])})}return e}function J(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}R(N,"propTypes",{onLogin:T.a.func.isRequired,inProgress:T.a.bool.isRequired,error:T.a.node});const M={localhost:!0,"127.0.0.1":!0,"0.0.0.0":!0},B={identity:"/.netlify/identity",gateway:"/.netlify/git"};function F(e,t){if(M[document.location.host.split(":").shift()]&&t&&e.match(/^\/\.netlify\//)){const r=[];return t&&(r.push(t),t.match(/\/$/)||r.push("/")),r.push(e.replace(/^\//,"")),r.join("")}return e}class ${constructor(e,t={}){J(this,"requestFunction",e=>this.tokenPromise().then(t=>f.unsentRequest.withHeaders({Authorization:`Bearer ${t}`},e)).then(f.unsentRequest.performRequest)),this.options=D({proxied:!0,API:null},t),this.config=e,this.branch=e.getIn(["backend","branch"],"master").trim(),this.squash_merges=e.getIn(["backend","squash_merges"]);const r=localStorage.getItem("netlifySiteURL"),n=F(e.getIn(["backend","identity_url"],B.identity),r);this.gatewayUrl=F(e.getIn(["backend","gateway_url"],B.gateway),r);const i=/\/(github|gitlab|bitbucket)\/?$/,o=this.gatewayUrl.match(i);o?(this.backendType=o[1],this.gatewayUrl=this.gatewayUrl.replace(i,"/")):this.backendType=null,this.authClient=window.netlifyIdentity?window.netlifyIdentity.gotrue:new l.a({APIUrl:n}),N.authClient=this.authClient,this.backend=null}authenticate(e){return this.tokenPromise=e.jwt.bind(e),this.tokenPromise().then(async t=>{if(!this.backendType){const e=await fetch(`${this.gatewayUrl}/settings`,{headers:{Authorization:`Bearer ${t}`}}).then(async e=>{const t=e.headers.get("Content-Type");if("application/json"!==t&&"text/json"!==t)throw new f.APIError("Your Git Gateway backend is not returning valid settings. Please make sure it is enabled.",e.status,"Git Gateway");const r=await e.json();if(!e.ok)throw new f.APIError(`Git Gateway Error: ${r.message?r.message:r}`,e.status,"Git Gateway");return r}),r=e.github_enabled,n=e.gitlab_enabled,i=e.bitbucket_enabled,o=e.roles;this.acceptRoles=o,r?this.backendType="github":n?this.backendType="gitlab":i&&(this.backendType="bitbucket")}if(this.acceptRoles&&this.acceptRoles.length>0){const e=u()(d()(t),"app_metadata.roles",[]);if(!(i()(e,this.acceptRoles).length>0))throw new Error("You don't have sufficient permissions to access Netlify CMS")}const r={name:e.user_metadata.name||e.email.split("@").shift(),email:e.email,avatar_url:e.user_metadata.avatar_url,metadata:e.user_metadata},n={api_root:`${this.gatewayUrl}/${this.backendType}`,branch:this.branch,tokenPromise:this.tokenPromise,commitAuthor:s()(r,["name","email"]),squash_merges:this.squash_merges,initialWorkflowStatus:this.options.initialWorkflowStatus};if("github"===this.backendType?(this.api=new v(n),this.backend=new p.GitHubBackend(this.config,D({},this.options,{API:this.api}))):"gitlab"===this.backendType?(this.api=new P(n),this.backend=new y.GitLabBackend(this.config,D({},this.options,{API:this.api}))):"bitbucket"===this.backendType&&(this.api=new m.API(D({},n,{requestFunction:this.requestFunction,hasWriteAccess:async()=>!0})),this.backend=new m.BitBucketBackend(this.config,D({},this.options,{API:this.api}))),!await this.api.hasWriteAccess())throw new Error("You don't have sufficient permissions to access Netlify CMS")})}restoreUser(){const e=this.authClient&&this.authClient.currentUser();return e?this.authenticate(e):Promise.reject()}authComponent(){return N}logout(){if(window.netlifyIdentity)return window.netlifyIdentity.logout();const e=this.authClient.currentUser();return e&&e.logout()}getToken(){return this.tokenPromise()}entriesByFolder(e,t){return this.backend.entriesByFolder(e,t)}entriesByFiles(e){return this.backend.entriesByFiles(e)}fetchFiles(e){return this.backend.fetchFiles(e)}getEntry(e,t,r){return this.backend.getEntry(e,t,r)}getMedia(){return this.backend.getMedia()}persistEntry(e,t,r){return this.backend.persistEntry(e,t,r)}persistMedia(e,t){return this.backend.persistMedia(e,t)}deleteFile(e,t,r){return this.backend.deleteFile(e,t,r)}unpublishedEntries(){return this.backend.unpublishedEntries()}unpublishedEntry(e,t){return this.backend.unpublishedEntry(e,t)}updateUnpublishedEntryStatus(e,t,r){return this.backend.updateUnpublishedEntryStatus(e,t,r)}deleteUnpublishedEntry(e,t){return this.backend.deleteUnpublishedEntry(e,t)}publishUnpublishedEntry(e,t){return this.backend.publishUnpublishedEntry(e,t)}traverseCursor(e,t){return this.backend.traverseCursor(e,t)}}r.d(t,"GitGatewayBackend",function(){return $}),r.d(t,"AuthenticationPage",function(){return N})}])});
//# sourceMappingURL=netlify-cms-backend-git-gateway.js.map